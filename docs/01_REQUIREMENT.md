# 要求仕様書

## 概要

「ソロ優美な屍骸」支援アプリ

本アプリは、ユーザーが入力した複数の短文 (以下「断片」と呼ぶ) をもとに、ユーザーとのインタラクティブな文章生成を行うWebアプリである。  
目的は、ユーザーが「断片の続きを書く」過程を通じて、偶発的な創作体験を得ること。

## システム全体の流れ

1. **文の登録**
   - ユーザーは、最初に複数の断片 (1文にも満たない程度の文) を入力し、「箱」に追加する。
     - 断片には、任意の内容と「位置」 (文頭、文中、文末など) を設定できる。
   - すべての断片はリストとして保持される。
   - 追加可能な断片の数は、位置あたり1～5個までとする。
   - 断片あたりの最大文字数は30文字までとする。

2. **形態素解析とトークン選択**
   - アプリは、箱に入っている未完の断片の中からランダムに1つを選ぶ。
   - その断片の位置と、前後どちらが空いているかに応じて、断片を形態素解析した結果から「最初の部分」または「最後の部分」を抽出する。
     - 前が空いている場合：**最初のnトークン**または**最初のn文字**を抽出する。
     - 後が空いている場合：**最後のmトークン**または**最後のm文字**を抽出する。
     - n, mの値はユーザーが設定可能とする。

3. **ユーザーの追記**
   - アプリは、抽出した「最初の部分」または「最後の部分」をユーザーに提示する。
   - ユーザーはその部分に繋がる文章を入力する。
     - 例えば、後が空いている断片に対しては「最後の部分」を提示し、その後に続く文章をユーザーが入力する形とする。
     - 入力可能な文字数は30文字までとする。
     - 改行文字、制御文字 (C0制御文字, C1制御文字, 双方向制御文字) は入力不可とする。
   - 入力が完了すると、アプリはそれを当該断片に追記し、「断片の繋がり」を更新する。

4. **繰り返し**
   - アプリは、再び別の未完の断片をランダムに選び、同様の処理 (形態素解析→最後の部分提示→ユーザー追記) を行う。
   - 文頭→任意の数の文中→文末の繋がりが完成するまで、このプロセスを繰り返す。
   - 完成した一連の断片は「完成文」として扱われ、以降は全て出題対象から除外される。

5. **始端条件**
   - ユーザーが「前が空いている」断片に対して追記を行う場合、その断片はn%の確率で「始端」となる。
     - nの値はユーザーが設定可能とする。

6. **終端条件**
   - ユーザーが「後が空いている」断片に対して追記を行う場合、その断片はm%の確率で「終端」となる。
     - mの値はユーザーが設定可能とする。
   - もしくはユーザーが「。」「！」「？」などの終端記号で文章を終了した場合も、当該断片は「終端」となる。
     - 終端記号はユーザーが設定可能とする。設定しなかった場合、確率でのみ終端となる。
   - ねらい：シュルレアリスム的な偶発性を促進するため、確率的な終端をデフォルトとする。プレイ感が悪い場合、終端記号を設定することで終端のみを明示的に指定できる。

7. **完成と出力**
   - すべての文が完成した時点で、アプリは全ての完成文を**ランダムな順序で並べ替え**、最終的な文章群として表示する。
   - ユーザーはこれをURL共有できる。
     - 共有はURLのハッシュ (フラグメント識別子) に全ての完成文をLZ圧縮して含める形で実装する。改変を防ぐため、簡単なチェックサムを連結する。

## 詳細仕様

### 初期設定

- 初期化時、以下をパラメータとして設定できる。
  - 抽出トークン数n (前が空いている場合)
  - 抽出文字数n (前が空いている場合)
  - 抽出トークン数m (後が空いている場合)
  - 抽出文字数m (後が空いている場合)
  - 始端確率n%
  - 終端確率m%
  - 終端記号リスト
- また、ユーザーは任意の数および位置の断片を登録できる。

### 入力仕様

- 入力対象：テキスト (1行のみ)
- 登録された断片はIDで管理する。
- 登録時に形態素解析を実行。

### 出題仕様

- 出題対象：未完の断片のみ
- 選択方法：以下のルールに基づきランダムに選択
  - 直前に出題した断片は可能な限り避ける。
  - 直前にユーザーが追加した断片は可能な限り避ける。
- 提示内容：ユーザー設定に基づく最後のnトークンまたは最後のn文字のうち、どちらか短い方。
